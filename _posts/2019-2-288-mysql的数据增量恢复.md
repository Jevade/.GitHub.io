---
layout:     post
title:     mysql的数据增量恢复 
category: blog
description: mysql数据库误删时候的增量恢复
tag: mysql,binlog,增量恢复
---

## mysql的日志机制
mysql具有日志机制，以保证数据库的数据安全。常见的主要有两种，redo log和binlog。
1. binlog是mysql本身具备的备份机制，为逻辑日志，会记录每一次操作的数据行前后变化，或者是每一次操作的sql。而redo log为物理日志，会记录每一次操作的具体描述；
2. redo log是InnoDB引擎的插件，并且日志是循环记录的，如果采用其他的引擎，就不会有这个日志。redo log日志能够保证事务的完成。也就是当mysql当掉的时候，保证提交事务在下一次重启之后依然会正确完成；
3. binlog是归档机制，会依次记录数据库的所有操作，因此当误删数据的时候，能够依靠binlog实现数据的恢复。备份频率高的话，消耗资源大，但是当出现数据丢失的时候，恢复速度快。
## 开启mysql的binlog机制
binlog比较占用磁盘空间，所有binlog不一定默认打开了，我使用的MySQL容器里面，binlog是打开的，可能是制作容器的前辈已经配置好了。在我mac上的MySQL默认是没有打开的。在打开MySQL之后，在命令行可以查看binlog是否开启。
显示`log_bin_` 开头的变量值。
	mysql> show variables like 'log_bin%';
	+---------------------------------+--------------------------------------+
	| Variable_name                   | Value                                |
	+---------------------------------+--------------------------------------+
	| log_bin                         | ON                                   |
	| log_bin_basename                | /usr/local/var/mysql/mysql-bin       |
	| log_bin_index                   | /usr/local/var/mysql/mysql-bin.index |
	| log_bin_trust_function_creators | OFF                                  |
	| log_bin_use_v1_row_events       | OFF                                  |
	+---------------------------------+--------------------------------------+
	5 rows in set (0.01 sec)

在这里是`ON`表示binlog已经开启了，如果是`OFF`的话，需要修改配置文件，并重启mysql服务。
显示MySQL配置文件的位置，
	➜  ~ mysql --help --verbose | grep my.cnf
	                      order of preference, my.cnf, $MYSQL_TCP_PORT,
	/etc/my.cnf /etc/mysql/my.cnf /usr/local/etc/my.cnf ~/.my.cnfsudo /usr/local/MySQL/support-files/mysql.server restart

` /etc/my.cnf `默认可能没有，可以自己创建一下。

	#vim  /etc/my.cnf
	[mysqld]
	log-bin = mysql-bin #开启binlog
	binlog-format = ROW #选择row模式
	server_id = 1 #配置mysql replication需要定义，不能喝canal的slaveId重复

重启MySQL
	 sudo /usr/local/MySQL/support-files/mysql.server restart
进入MySQL后，查看binlog信息：
	mysql> show master logs;
	+------------------+-----------+
	| Log_name         | File_size |
	+------------------+-----------+
	| mysql-bin.000001 |      1600 |
	| mysql-bin.000002 |      1411 |
	| mysql-bin.000003 |      6827 |
	| mysql-bin.000004 |       201 |
	| mysql-bin.000005 |       601 |
	| mysql-bin.000006 |      1548 |
	| mysql-bin.000007 |       201 |
	| mysql-bin.000008 |      4045 |
	| mysql-bin.000009 |      2186 |
	+------------------+-----------+
	9 rows in set (0.00 sec)

查找`mysql-bin. 000001 `的存放位置
	➜  ~ sudo find / -name mysql-bin.000001
	/usr/local/var/mysql/mysql-bin.000001
	/usr/local/mysql-5.7.18-macos10.12-x86_64/data/mysql-bin.000001
我的存放地址其实就是`' /usr/local/var/mysql/mysql-bin.000001 `
第二个地址可能是之前安装的残留文件
	 mysqldump -uroot -p123456 -lF --log-error=/Users/liu/myDump.err -B T > ~/BAK.T.sql